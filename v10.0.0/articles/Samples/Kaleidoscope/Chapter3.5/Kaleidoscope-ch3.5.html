<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>3.5 Kaleidoscope: Generating LLVM IR With optimizations | Ubiquity.NET.Llvm </title>
      <meta name="viewport" content="width=device-width">
      <meta name="title" content="3.5 Kaleidoscope: Generating LLVM IR With optimizations | Ubiquity.NET.Llvm ">
    
    
      <link rel="shortcut icon" href="../../../../favicon.ico">
      <link rel="stylesheet" href="../../../../styles/docfx.vendor.min.css">
      <link rel="stylesheet" href="../../../../styles/docfx.css">
      <link rel="stylesheet" href="../../../../styles/main.css">
      <meta property="docfx:navrel" content="../../../../toc.json">
      <meta property="docfx:tocrel" content="../../toc.json">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../../../../index.html">
                <img id="logo" class="svg" src="../../../../DragonSharp48x48.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>

                <ul class="nav level1 navbar-nav">
                      <li>
                          <a href="../../../../api/index.html" title="API Documentation">API Documentation</a>
                      </li>
                      <li>
                          <a href="https://github.com/UbiquityDotNET/Llvm.NET" title="Source Repository">Source Repository</a>
                      </li>
                      <li>
                          <a href="http://LLVM.org" title="LLVM.org">LLVM.org</a>
                      </li>
                      <li>
                          <a href="http://releases.llvm.org/20.1.0/docs/index.html" title="LLVM Docs">LLVM Docs</a>
                      </li>
                </ul>
            </div>
          </div>
        </nav>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div>
              <div class="sidefilter">
                <form class="toc-filter">
                  <span class="glyphicon glyphicon-filter filter-icon"></span>
                  <input type="text" id="toc_filter_input" placeholder="Enter here to filter..." onkeypress="if(event.keyCode==13) {return false;}">
                </form>
              </div>
              <div class="sidetoc">
                <div class="toc" id="toc">

                  <ul class="nav level1">
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Samples</a>

                        <ul class="nav level2">
                          <li class="">
                            <a href="../../CodeGenWithDebugInfo/codegeneration.html" title="CodeGenerator With Debug Information" class="">CodeGenerator With Debug Information</a>
                          </li>
                          <li class="">
                            <a href="../../OrcV2VeryLazy/OrcV2VeryLazy.html" title="OrcV2VeryLazy" class="">OrcV2VeryLazy</a>
                          </li>
                        </ul>
                    </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Kaleidoscope</a>

                        <ul class="nav level2">
                          <li class="">
                            <a href="../../Kaleidoscope/Kaleidoscope-Overview.html" title="Chapter 1 - Language Introduction" class="">Chapter 1 - Language Introduction</a>
                          </li>
                          <li class="">
                            <a href="../../Kaleidoscope/Chapter2/Kaleidoscope-ch2.html" title="Chapter 2 - Implementing the parser" class="">Chapter 2 - Implementing the parser</a>
                          </li>
                          <li class="">
                            <span class="expand-stub"></span>
                            <a href="../../Kaleidoscope/Chapter3/Kaleidoscope-ch3.html" title="Chapter 3 - Generating LLVM IR" class="">Chapter 3 - Generating LLVM IR</a>

                              <ul class="nav level3">
                                <li class="">
                                  <a href="../../Kaleidoscope/Chapter3/Kaleidoscope-ch3.html" title="Chapter 3 - Generating LLVM IR With Optimization" class="">Chapter 3 - Generating LLVM IR With Optimization</a>
                                </li>
                              </ul>
                          </li>
                          <li class="">
                            <a href="../../Kaleidoscope/Chapter4/Kaleidoscope-ch4.html" title="Chapter 4 - JIT and Optimizer Support" class="">Chapter 4 - JIT and Optimizer Support</a>
                          </li>
                          <li class="">
                            <a href="../../Kaleidoscope/Chapter5/Kaleidoscope-ch5.html" title="Chapter 5 - Control Flow" class="">Chapter 5 - Control Flow</a>
                          </li>
                          <li class="">
                            <a href="../../Kaleidoscope/Chapter6/Kaleidoscope-ch6.html" title="Chapter 6 - User Defined Operators" class="">Chapter 6 - User Defined Operators</a>
                          </li>
                          <li class="">
                            <span class="expand-stub"></span>
                            <a href="../../Kaleidoscope/Chapter7/Kaleidoscope-ch7.html" title="Chapter 7 - Mutable Variables" class="">Chapter 7 - Mutable Variables</a>

                              <ul class="nav level3">
                                <li class="">
                                  <a href="../../Kaleidoscope/Chapter7.1/Kaleidoscope-ch7.1.html" title="Chapter 7.1 - Extreme Lazy JIT" class="">Chapter 7.1 - Extreme Lazy JIT</a>
                                </li>
                              </ul>
                          </li>
                          <li class="">
                            <a href="../../Kaleidoscope/Chapter8/Kaleidoscope-ch8.html" title="Chapter 8 - AOT Compilation" class="">Chapter 8 - AOT Compilation</a>
                          </li>
                          <li class="">
                            <a href="../../Kaleidoscope/Chapter9/Kaleidoscope-ch9.html" title="Chapter 9 - Debug Information" class="">Chapter 9 - Debug Information</a>
                          </li>
                          <li class="">
                            <span class="expand-stub"></span>
                            <a class="">Appendix</a>

                              <ul class="nav level3">
                                <li class="">
                                  <a href="../../Kaleidoscope/Kaleidoscope.Runtime/Kaleidoscope-Runtime.html" title="Kaleidoscope.Runtime" class="">Kaleidoscope.Runtime</a>
                                </li>
                                <li class="">
                                  <a href="../../Kaleidoscope/Kaleidoscope.Parser/AST/Kaleidoscope-AST.html" title="Kaleidoscope AST" class="">Kaleidoscope AST</a>
                                </li>
                                <li class="">
                                  <a href="../../Kaleidoscope/Kaleidoscope.Parser/ANTLR/Kaleidoscope-ParseTreeVisitor.html" title="ParseTree Visitor" class="">ParseTree Visitor</a>
                                </li>
                                <li class="">
                                  <a href="../../Kaleidoscope/Kaleidoscope.Parser/ANTLR/Kaleidoscope-Parsetree-examples.html" title="ParseTree Examples" class="">ParseTree Examples</a>
                                </li>
                              </ul>
                          </li>
                        </ul>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="Kaleidoscope-ch3.5">
<h1 id="35-kaleidoscope-generating-llvm-ir-with-optimizations">3.5 Kaleidoscope: Generating LLVM IR With optimizations</h1>

<p>This chapter focuses on the basics of optimization with LLVM IR. It diverges from the official tutorial
where that mixes the optimization with the use of a JIT. This sub chapter is attempting to isolate those
and was born as a means to test/validate the core library and optimization without a JIT. The general
goal is to parse Kaleidoscope source code to generate a <a class="xref" href="../../../../api/Ubiquity.NET.Llvm.Module.html">Module</a>
representing the source as optimized LLVM IR. This is broken out as a distinct chapter to help
identify the support for profiling and how it is different from the LLVM source samples that
link directly to the LLVM libraries (That is, the samples are written in C++ AND continue to use
the C++ pass builder and management support. This level of functionality is only available as the
legacy pass management system with VERY limited support in the LLVM-C API. [It is so legacy now that
almost ALL remnants of it are removed from the LLVM-C API, not just dpeprecated])</p>
<h2 id="code-generation">Code generation</h2>
<p>The Core of this sample doesn't change much from <a class="xref" href="../Chapter3/Kaleidoscope-ch3.html">Chapter 3</a>. It simply adds
module generation with optimized IR. To do that there are a few changes to make. In fact the optimizations
provided don't do much and the resulting IR is much the same.<br>
[Coming up with a more complex Kaleidoscope
sample that actually uses the optimizations more is left as an excercise for the reader. 😉 ]</p>
<h3 id="initialization">Initialization</h3>
<p>The code generation maintains state for the transformation as private members. To support optimization
generally only requires a set of named passes and to call the method to run the passes on a function or
module. [Technically an overlod provides the chance to set <a class="xref" href="../../../../api/Ubiquity.NET.Llvm.PassBuilderOptions.html">PassBuilderOptions</a> but
this sample just uses the overload that applies defaults.] The new pass management system
uses the string names of passes instead of a distinct type and named methods for adding them etc...</p>
<p>These Options are initialized in a private static member for the passes.</p>
<pre><code class="lang-csharp" name="Main">private readonly Module Module;
private readonly DynamicRuntimeState RuntimeState;
private readonly Context Context;
private readonly InstructionBuilder InstructionBuilder;
private readonly Dictionary&lt;string, Value&gt; NamedValues = [];
private static readonly string[] PassNames = [
    &quot;default&lt;O3&gt;&quot;
];
</code></pre><h3 id="special-attributes-for-parsed-functions">Special attributes for parsed functions</h3>
<p>When performing optimizations with the new pass builder system the TargetLibraryInfo (Internal LLVM concept) is
used to determine what the &quot;built-in&quot; functions are. Unfortunately they leave little room for manipulating or
customizing this set (In C++, in LLVM-C there is NO support for this type at all!). Unfortunately that means that
if any function happens to have the same name as the TargetLibraryInfo for a given Triple then it will be optimized
AS a built-in function (even if not declared as one). This is an unfortunate state of affairs with the LLVM support
for C++ and highly problematic for <code>C</code> based bindings/projections like this library. Fortunately there is a scapegoat
for this. The function can include a <code>nobuiltin</code> attribute to prevent the optimizer from assuming calls to it are
one of the well known built-in functions. This is used for ALL methods that come from the AST, which is all functions
at this point in the language design. Thus <code>GetOrDeclareFunction</code> will add that attribute for any function creations.</p>
<pre><code class="lang-csharp" name="Main">
// Retrieves a Function for a prototype from the current module if it exists,
// otherwise declares the function and returns the newly declared function.
private Function GetOrDeclareFunction(Prototype prototype)
{
    if(Module.TryGetFunction( prototype.Name, out Function? function ))
    {
        return function;
    }

    var llvmSignature = Context.GetFunctionType( returnType: Context.DoubleType, args: prototype.Parameters.Select( _ =&gt; Context.DoubleType ) );
    var retVal = Module.CreateFunction( prototype.Name, llvmSignature );
    retVal.AddAttribute( FunctionAttributeIndex.Function, prototype.IsExtern ? AttributeKind.BuiltIn : AttributeKind.NoBuiltIn );

    int index = 0;
    foreach(var argId in prototype.Parameters)
    {
        retVal.Parameters[ index ].Name = argId.Name;
        ++index;
    }

    return retVal;
}
</code></pre><h3 id="function-definition">Function Definition</h3>
<p>The only other major change for optimization support is to actually run the optimizations. In LLVM optimizations
are supported at the module or individual function level. For this sample each function definition is optimised
as each is returned individually. That will change in later chapters. Thus the only real change is after generating
a new function for a given AST definition the optimization passes are run for it. This involves calling one of the
overloads of the <code>TryRunPasses</code> function and then checking for errors.</p>
<pre><code class="lang-csharp" name="Main">public override Value? Visit(FunctionDefinition definition)
{
    ArgumentNullException.ThrowIfNull( definition );

    var function = GetOrDeclareFunction( definition.Signature );
    if(!function.IsDeclaration)
    {
        throw new CodeGeneratorException( $&quot;Function {function.Name} cannot be redefined in the same module&quot; );
    }

    try
    {
        var entryBlock = function.AppendBasicBlock( &quot;entry&quot; );
        InstructionBuilder.PositionAtEnd( entryBlock );
        NamedValues.Clear();
        foreach(var param in definition.Signature.Parameters)
        {
            NamedValues[ param.Name ] = function.Parameters[ param.Index ];
        }

        var funcReturn = definition.Body.Accept( this ) ?? throw new CodeGeneratorException( ExpectValidFunc );
        InstructionBuilder.Return( funcReturn );
        function.Verify();

        // pass pipeline is run against the module
        using var errInfo = function.ParentModule.TryRunPasses( PassNames );
        return errInfo.Success ? (Value)function : throw new CodeGeneratorException( errInfo.ToString() );
    }
    catch(CodeGeneratorException)
    {
        function.EraseFromParent();
        throw;
    }
}
</code></pre>
</article>
          </div>
          <div class="contribution-panel mobile-hide">
              <a href="https://github.com/UbiquityDotNET/Llvm.NET/blob/develop/samples/Kaleidoscope/Chapter3.5/Kaleidoscope-ch3.5.md/#L1" title="Edit this page" class="fab btn-warning pull-right"><i class="glyphicon glyphicon-pencil"></i></a>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      Copyright (C) 2017-2025, Ubiquity.NET Contributors<br><strong>Build:</strong> 20.1.0-alpha.0.0.ci-ZZZ.603654671
      
          </div>
        </div>
      </footer>
    </div>

    <script type="text/javascript" src="../../../../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../../styles/main.js"></script>
  </body>
</html>
