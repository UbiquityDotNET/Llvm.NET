<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>1. Kaleidoscope: Language Introduction | Ubiquity.NET </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="1. Kaleidoscope: Language Introduction | Ubiquity.NET ">
      
      
      <link rel="icon" href="../../../../favicon.ico">
      <link rel="stylesheet" href="../../../../public/docfx.min.css">
      <link rel="stylesheet" href="../../../../public/main.css">
      <meta name="docfx:navrel" content="../../../../toc.html">
      <meta name="docfx:tocrel" content="../../../toc.html">
      
      
      
      
      <meta name="docfx:docurl" content="https://github.com/UbiquityDotNET/Llvm.NET/blob/develop/src/Samples/Kaleidoscope/Kaleidoscope-Overview.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../../../index.html">
            <img id="logo" class="svg" src="../../../../llvm/DragonSharp48x48.png" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

        </div>

        <article data-uid="Kaleidoscope-ch1">
<h1 id="1-kaleidoscope-language-introduction">1. Kaleidoscope: Language Introduction</h1>

<p>The general flow of this tutorial follows that of the official
<a class="xref" href="https://releases.llvm.org/20.1.0/docs/tutorial/MyFirstLanguageFrontend/index.html">LLVM tutorial</a>
and many of the samples are lifted directly from that tutorial to make it easier to follow
along both tutorials to see how the various LLVM concepts are projected in the
<code>Ubiquity.NET.Llvm library.</code></p>
<div class="NOTE">
<h5>Note</h5>
<p>The samples are all setup to include <code>&lt;PublishAot&gt;True&lt;/PublishAot&gt;</code> and therefore support
AOT code generation. To use that you only need to run
<code>dotnet publish &lt;project path&gt; -r &lt;RID&gt;</code> to build the native standalone version of the
app. This demonstrates that the libraries are AOT compatible. While this makes things run
faster as no .NET JIT is used, everything is already native code, it has the drawback of
making the app RID specific. That is, you must AOT build for EVERY supported RID target.
Each usage case must make a choice and there is no single &quot;one size fits all&quot; answer.
Thus, the samples and the library itself allow for, but <em><strong>Do NOT require</strong></em>, AOT builds.</p>
</div>
<h2 id="overview">Overview</h2>
<p>Kaleidoscope is a simple functional language that is used to illustrate numerous real world
use cases for Ubiquity.NET.Llvm for code generation and JIT execution.</p>
<p>It is worth pointing out that this example is not intended as a treatise on compiler design
nor on language parsing. While it contains many aspects of those topics the tutorial is,
mostly, focused on the use of Ubiquity.NET.Llvm for code generation. Furthermore it isn't
a trans-literation of the LLVM <code>C++</code> sample as that would defeat one of the major points of
<code>Ubiquity.NET.Llvm</code> - to provide a familiar API and use patterns familiar to C# developers.</p>
<h2 id="general-layout">General layout</h2>
<p>The samples are built using common core libraries and patterns. They are explicitly designed
to make code comparisons between chapters via your favorite code comparison tool. Each,
chapter builds on the next so running a comparison makes it easy to see the changes in full
context. The text of the tutorials explains why the changes are made and a comparison helps
provide the &quot;big picture&quot; view.</p>
<h2 id="variations-from-the-official-llvm-tutorial">Variations from the Official LLVM Tutorial</h2>
<p>The Ubiquity.NET.Llvm version of the Kaleidoscope series takes a different route for parsing
from the LLVM implementation. In particular the Ubiquity.NET.Llvm version defines a formal
grammar using <a href="http://antlr.org">ANTLR4</a> with the full grammar for all variations of the
language features in a single assembly. Ultimately the parsing produces an
<a class="xref" href="Kaleidoscope.Grammar/AST/Kaleidoscope-AST.html">AST</a> so that the actual technology used for the parse is hidden as
an implementation detail. This helps in isolating the parsing from the use of
<code>Ubiquity.NET.Llvm</code> for code generation and JIT compilation for interactive languages.
Additionally, a number of <a href="https://github.com/UbiquityDotNET/Ubiquity.NET.Utils">utilities</a>
are used to further enable use by additional DSL implementations or any other use.</p>
<h2 id="the-kaleidoscope-language">The Kaleidoscope Language</h2>
<h3 id="general-concepts">General Concepts</h3>
<p>Kaleidoscope is a simple functional language with the following major features:</p>
<ul>
<li>Only a single data type (equivalent to C double)</li>
<li>Built-in operators for basic expressions</li>
<li>If/then/else style control flow</li>
<li>For loop style control flow</li>
<li>User defined operators
<ul>
<li>User defined operators can specify operator precedence
<ul>
<li>User defined precedence is arguably the most complex part of parsing and implementing
the language. Though, ANTLR4's flexibility made it fairly easy to do once fully
understood. (more details in <a class="xref" href="Chapter6/Kaleidoscope-ch6.html">Chapter 6</a>)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="expressions">Expressions</h3>
<p>In Kaleidoscope, everything is an expression (e.g. everything has or returns a value even
if the value is a constant 0.0). There are no statements and no &quot;void&quot; functions etc...</p>
<h4 id="multi-line-expressions">Multi-line expressions</h4>
<p>There are a few different ways to represent an expression that is long enough to warrant
splitting it across multiple lines when typing it out.</p>
<h5 id="expression-continuation-marker">Expression Continuation Marker</h5>
<p>One mechanism for handling multi-line expressions that is used in most shell scripting
languages is a line continuation marker. In such cases a special character followed by a
line-termination char or char sequence indicates that the expression continues on the next
line (e.g. it isn't complete yet).</p>
<h5 id="expression-complete-marker">Expression Complete Marker</h5>
<p>Another approach to handling long expressions spanning multiple lines is basically the
opposite of line continuation, expression complete markers. This marker indicates the end
of a potentially multi-line expression. (A variant of this might require a line termination
following the marker as with the line continuation).</p>
<h5 id="kaleidoscope-implementation">Kaleidoscope Implementation</h5>
<p>The original LLVM C++ implementation chose the expression completion approach using a
semicolon as the completion. (So it seems familiar like statements in other C like languages
) Therefore, the Ubiquity.NET.Llvm tutorial follows the same design. [Implementing the line
continuation mechanism in Kaleidoscope is left as an exercise for the reader - though if you
come up with a mechanism to support either that is determined by the calling application;
PRs are welcome! ðŸ˜‰]</p>
<h3 id="example">Example</h3>
<p>The following example is a complete program in Kaleidoscope that will generate a textual
representation of the classic Mandelbrot Set.</p>
<pre><code class="lang-Kaleidoscope" name="mandel.kls"># unary operator to perform a logical NOT
def unary!(v)
  if v then
    0
  else
    1;

# unary operator to perform a mathematical negation
def unary-(v)
  0-v;

# Comparison operator
def binary&gt; 10 (LHS RHS)
  RHS &lt; LHS;

# Logical OR operator
def binary| 5 (LHS RHS)
  if LHS then
    1
  else if RHS then
    1
  else
    0;

# Logical AND operator
def binary&amp; 6 (LHS RHS)
  if !LHS then
    0
  else
    !!RHS;

# arithmatic equality test
def binary== 9 (LHS RHS)
  !(LHS &lt; RHS | LHS &gt; RHS);

# selector operator
def binary : 1 (x y) y;

# declare access to built-in function
extern putchard(char);

def printdensity(d)
  if d &gt; 8 then
    putchard(32)     # 32 =&gt; ASCII Space
  else if d &gt; 4 then
    putchard(46)     # 46 =&gt; ASCII '.'
  else if d &gt; 2 then
    putchard(43)     # 43 =&gt; ASCII '+'
  else
    putchard(42);    # 43 =&gt; ASCII '*'

def mandelconverger(real imag iters creal cimag)
  if iters &gt; 255 | (real*real + imag*imag &gt; 4) then
    iters
  else
    mandelconverger( real*real - imag*imag + creal
                   , 2*real*imag + cimag
                   , iters+1
                   , creal
                   , cimag
                   );

def mandelconverge(real imag)
  mandelconverger(real, imag, 0, real, imag);

def mandelhelp(xmin xmax xstep   ymin ymax ystep)
  for y = ymin, y &lt; ymax, ystep in
  (
    (for x = xmin, x &lt; xmax, xstep in printdensity(mandelconverge(x,y))) : putchard(10)
  );

def mandel(realstart imagstart realmag imagmag)
  mandelhelp(realstart, realstart+realmag*78, realmag, imagstart, imagstart+imagmag*40, imagmag);

mandel(-2.3, -1.3, 0.05, 0.07);
</code></pre>
<p>When entered ( or copy/pasted) to the command line Kaleidoscope will print out the
following:</p>
<div class="NOTE">
<h5>Note</h5>
<p>This example uses features of the language only enabled/discussed in Chapter 6 of the
tutorial.The runtime from chapters 3-5 will generate errors trying to parse this code.</p>
</div>
<pre><code class="lang-shell">Ready&gt;mandel(-2.3, -1.3, 0.05, 0.07);
*******************************************************************************
*******************************************************************************
****************************************++++++*********************************
************************************+++++...++++++*****************************
*********************************++++++++.. ...+++++***************************
*******************************++++++++++..   ..+++++**************************
******************************++++++++++.     ..++++++*************************
****************************+++++++++....      ..++++++************************
**************************++++++++.......      .....++++***********************
*************************++++++++.   .            ... .++**********************
***********************++++++++...                     ++**********************
*********************+++++++++....                    .+++*********************
******************+++..+++++....                      ..+++********************
**************++++++. ..........                        +++********************
***********++++++++..        ..                         .++********************
*********++++++++++...                                 .++++*******************
********++++++++++..                                   .++++*******************
*******++++++.....                                    ..++++*******************
*******+........                                     ...++++*******************
*******+... ....                                     ...++++*******************
*******+++++......                                    ..++++*******************
*******++++++++++...                                   .++++*******************
*********++++++++++...                                  ++++*******************
**********+++++++++..        ..                        ..++********************
*************++++++.. ..........                        +++********************
******************+++...+++.....                      ..+++********************
*********************+++++++++....                    ..++*********************
***********************++++++++...                     +++*********************
*************************+++++++..   .            ... .++**********************
**************************++++++++.......      ......+++***********************
****************************+++++++++....      ..++++++************************
*****************************++++++++++..     ..++++++*************************
*******************************++++++++++..  ...+++++**************************
*********************************++++++++.. ...+++++***************************
***********************************++++++....+++++*****************************
***************************************++++++++********************************
*******************************************************************************
*******************************************************************************
*******************************************************************************
*******************************************************************************
*******************************************************************************
Evaluated to 0
Ready&gt;
</code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>Kaleidoscope is a simple language with a good deal of functionality. This serves as a great
language to study the use of <code>Ubiquity.NET.Llvm</code> for code generation and Domain Specific
Languages (DSLs) in general. While, generally speaking, the functionality of the
<code>Ubiquity.NET.Llvm</code> version of this tutorial differs only slightly from that of the official
LLVM version, it serves well as an example of what you can do with <code>Ubiquity.NET.Llvm.</code></p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/UbiquityDotNET/Llvm.NET/blob/develop/src/Samples/Kaleidoscope/Kaleidoscope-Overview.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>


    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          Copyright (C) 2017-2025, Ubiquity.NET Contributors
          - Build: 20.1.8
        </div>
      </div>
    </footer>
  </body>
</html>
