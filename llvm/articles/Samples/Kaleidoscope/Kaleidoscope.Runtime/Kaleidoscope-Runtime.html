<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Kaleidoscope.Runtime Library | Ubiquity.NET </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Kaleidoscope.Runtime Library | Ubiquity.NET ">
      
      
      <link rel="icon" href="../../../../../favicon.ico">
      <link rel="stylesheet" href="../../../../../public/docfx.min.css">
      <link rel="stylesheet" href="../../../../../public/main.css">
      <meta name="docfx:navrel" content="../../../../../toc.html">
      <meta name="docfx:tocrel" content="../../../../toc.html">
      
      
      
      
      <meta name="docfx:docurl" content="https://github.com/UbiquityDotNET/Llvm.NET/blob/develop/src/Samples/Kaleidoscope/Kaleidoscope.Runtime/Kaleidoscope-Runtime.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../../../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../../../../index.html">
            <img id="logo" class="svg" src="../../../../../llvm/DragonSharp48x48.png" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

        </div>

        <article data-uid="Kaleidoscope-Runtime">
<h1 id="kaleidoscoperuntime-library">Kaleidoscope.Runtime Library</h1>

<p>The Kaleidoscope.Runtime Library provides a set of common support libraries to aid in keeping the
tutorial chapter code focused on the code generation and JIT support in Ubiquity.NET.Llvm rather then the
particulars of the Kaleidoscope language in general. It serves as a useful reference for the implementation
of other custom DSLs. (Along with a core part of the sample infrastructure of this repository)</p>
<h2 id="kaleidoscope-specific-repl-loop-support">Kaleidoscope specific REPL Loop support</h2>
<p>The Kaleidoscope.Runtime library contains a language/runtime specific implementation of the classic Read,
Evaluate, Print, Loop (REPL) common for interactive/interpreted/JIT language run-times. This uses an
asynchronous pattern and allows cancellation via a standard cancellation token. This supports a clean shutdown
via a CTRl-C handler etc...</p>
<h2 id="kaleidoscope-jit-engine">Kaleidoscope JIT engine</h2>
<p>The JIT engine used for Kaleidoscope is based on the Ubiquity.NET.Llvm OrcJIT v2, which, unsurprisingly, uses
the LLVM OrcJit functionality to provide On Request Compilation (ORC). For most of the chapters, the JIT uses
a moderately lazy compilation technique where the source language is parsed, converted to LLVM IR and submitted
to the JIT engine. The JIT engine does not immediately generate native code from the module, however. Instead
it stores the module, and whenever compiled code calls to a symbol exported by the IR module, it will then
generate the native code for the function &quot;on the fly&quot;. This has the advantage of not paying the price of
converting IR to native code if it is never actually used, though it does have the cost of converting the
source language to IR, even if the code will never execute.</p>
<h3 id="really-lazy-compilation">Really lazy compilation</h3>
<p>While the basic lazy compilation of IR to native code has performance benefits over a pure interpreter, it
still has the potential for wasted overhead converting the parsed language to LLVM IR. Fortunately, the LLVM
and Ubiquity.NET.Llvm.OrcJitv2 supports truly lazy compilation. This is done by asking the JIT to create a
stub for a named symbol and then, whenever code calls that symbol the stub calls back to the JIT which then
calls back the application to 'materialize' the IR, add the module to the JIT and trigger compilation to
native. Thus, achieving true Just-In-Time compilation.</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/UbiquityDotNET/Llvm.NET/blob/develop/src/Samples/Kaleidoscope/Kaleidoscope.Runtime/Kaleidoscope-Runtime.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>


    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          Copyright (C) 2017-2025, Ubiquity.NET Contributors
          - Build: 20.1.8-alpha
        </div>
      </div>
    </footer>
  </body>
</html>
