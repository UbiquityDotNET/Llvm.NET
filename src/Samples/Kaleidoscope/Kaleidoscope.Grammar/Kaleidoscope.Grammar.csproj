<Project Sdk="Microsoft.NET.Sdk">
    <PropertyGroup>
        <TargetFramework>net9.0</TargetFramework>
        <TreatWarningsAsErrors>true</TreatWarningsAsErrors>
        <IsAotCompatible>True</IsAotCompatible>
    </PropertyGroup>

    <ItemGroup>
        <PackageReference Include="Antlr4" />
        <PackageReference Include="OpenSoftware.DgmlBuilder" />
    </ItemGroup>

    <ItemGroup>
      <ProjectReference Include="..\..\..\Ubiquity.NET.ANTLR.Utils\Ubiquity.NET.ANTLR.Utils.csproj" />
      <ProjectReference Include="..\..\..\Ubiquity.NET.InteropHelpers\Ubiquity.NET.InteropHelpers.csproj" />
      <ProjectReference Include="..\..\..\Ubiquity.NET.Runtime.Utils\Ubiquity.NET.Runtime.Utils.csproj" />
    </ItemGroup>

    <!-- TODO: Move this to directory level props as it is generally re-usable -->
    <!-- inline task from https://stackoverflow.com/questions/7837644/how-to-replace-string-in-file-using-msbuild -->
    <UsingTask TaskName="ReplaceFileText" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
        <ParameterGroup>
            <InputFilename ParameterType="System.String" Required="true" />
            <OutputFilename ParameterType="System.String" Required="true" />
            <MatchExpression ParameterType="System.String" Required="true" />
            <ReplacementText ParameterType="System.String" Required="true" />
        </ParameterGroup>
        <Task>
            <Using Namespace="System" />
            <Using Namespace="System.IO" />
            <Using Namespace="System.Text.RegularExpressions" />
            <Code Type="Fragment" Language="cs">
                <![CDATA[
            File.WriteAllText(
                OutputFilename,
                Regex.Replace(File.ReadAllText(InputFilename), MatchExpression, ReplacementText)
                );
          ]]>
            </Code>
        </Task>
    </UsingTask>

    <Target Name="ForceAntlrGeneratedCodeToInternal" AfterTargets="Antlr4Compile;Antlr4DesignTimeGrammarCompilation">
        <ReplaceFileText Condition="'%(Antlr4GeneratedCodeFiles.FullPath)'!=''"
            InputFileName="%(Antlr4GeneratedCodeFiles.FullPath)"
            OutputFileName="%(Antlr4GeneratedCodeFiles.FullPath)"
            MatchExpression="public (partial class|interface)"
            ReplacementText="internal $1" />
    </Target>
</Project>
